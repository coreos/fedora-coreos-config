# This file is most of a Fedora CoreOS like system; it inherits from "core".
# Add things in this file which are somewhat "opinionated", not necessarily
# core functionality.

include:
  - ignition-and-ostree.yaml
  - file-transfer.yaml

initramfs-args:
  - --no-hostonly
  # We don't support root on NFS, so we don't need it in the initramfs. It also
  # conflicts with /var mount support in ignition because NFS tries to mount stuff
  # in /var/ and then ignition can't cleanly unmount it. For example:
  # https://github.com/dracutdevs/dracut/blob/1856ae95c873a6fe855b3dccd0144f1a96b9e71c/modules.d/95nfs/nfs-start-rpc.sh#L7
  # See also discussion in https://github.com/coreos/fedora-coreos-config/pull/60
  - --omit=nfs
  # Omit these since we don't use them
  - --omit=lvm
  - --omit=iscsi

# Be minimal
recommends: false

ignore-removed-users:
  - root
ignore-removed-groups:
  - root
etc-group-members:
  - wheel
  - sudo
  - systemd-journal
  - adm

check-passwd:
  type: "file"
  filename: "passwd"
check-groups:
  type: "file"
  filename: "group"

default-target: multi-user.target

# ⚠⚠⚠ ONLY TEMPORARY HACKS ALLOWED HERE; ALL ENTRIES NEED TRACKER LINKS ⚠⚠⚠
# See also the version of this in fedora-coreos.yaml
postprocess:
  # This will be dropped once rpm-ostree because module-aware.
  # https://github.com/projectatomic/rpm-ostree/issues/1542#issuecomment-419684977
  # https://github.com/projectatomic/rpm-ostree/issues/1435
  - |
    #!/usr/bin/env bash
    set -xeuo pipefail
    for x in /etc/yum.repos.d/*modular.repo; do
      sed -i -e 's,enabled=[01],enabled=0,' ${x}
    done

  # Enable SELinux booleans used by OpenShift
  # https://github.com/coreos/fedora-coreos-tracker/issues/284
  - |
    #!/usr/bin/env bash
    set -xeuo pipefail
    setsebool -P -N container_use_cephfs on  # RHBZ#1692369
    setsebool -P -N virt_use_samba on  # RHBZ#1754825

  # No tracker issue filed. This handled build environment variation.
  # In order to make chrony use NTP settings from DHCP 
  # (https://github.com/coreos/fedora-coreos-config/pull/412), we need 
  # to chmod the following files to unset the writable permissions.
  # Git tracks only the executable bit of the permissions so when
  # the files get pulled locally they could have the group write bit set.
  # When that happens we get an error like:
  # `Cannot execute '/etc/NetworkManager/dispatcher.d/20-coreos-chrony-dhcp': writable by group or other`
  - |
    #!/usr/bin/env bash
    chmod 755 /etc/NetworkManager/dispatcher.d/20-coreos-chrony-dhcp
    chmod 755 /usr/libexec/coreos-chrony-helper
    chmod 755 /usr/lib/systemd/system-generators/coreos-platform-chrony

  # For F33 let's re-enable RSA-SHA1 keys for now so our kola tests will
  # work. The plan is to only re-enable this briefly while we wait for
  # an upstream feature [1] to be implemented. We had moved to an ecdsa
  # key [2] but AWS doesn't support non RSA keys [3] so we reverted it
  # for now in [4].
  #
  # [1] https://github.com/golang/go/issues/37278#issuecomment-704287991
  # [2] https://github.com/coreos/coreos-assembler/pull/1749
  # [3] https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#how-to-generate-your-own-key-and-import-it-to-aws
  # [4] https://github.com/coreos/coreos-assembler/pull/1767
  - |
    #!/usr/bin/env bash
    source /etc/os-release
    if [ "$VERSION_ID" != "32" ]; then
       cat > /etc/ssh/sshd_config.d/10-fcos-insecure-rsa-key.conf <<EOF
    # For now allow RSA-SHA1 keys.
    # https://github.com/coreos/coreos-assembler/issues/1772
    PubkeyAcceptedKeyTypes=+ssh-rsa
    EOF
    fi

packages:
  # Security
  - selinux-policy-targeted
  - polkit
  # System setup
  - afterburn
  - afterburn-dracut
  - passwd
  # Dependency of 20live dracut module
  - bsdtar
  # SSH
  - openssh-server openssh-clients
  - ssh-key-dir
  # Containers
  - podman skopeo runc systemd-container catatonit
  - fuse-overlayfs slirp4netns
  # Remote IPC for podman
  - libvarlink-util
  # Networking
  - nfs-utils-coreos
  - NetworkManager hostname
  - iproute-tc
  - adcli
  ## Teaming https://github.com/coreos/fedora-coreos-config/pull/289 and http://bugzilla.redhat.com/1758162
  - NetworkManager-team teamd
  # Static firewalling
  - iptables nftables iptables-nft iptables-services
  # Interactive Networking configuration during coreos-install
  - NetworkManager-tui
  # WireGuard https://github.com/coreos/fedora-coreos-tracker/issues/362
  - wireguard-tools
  # Storage
  - cloud-utils-growpart
  - lvm2 iscsi-initiator-utils sg3_utils
  - device-mapper-multipath
  - xfsprogs e2fsprogs btrfs-progs mdadm
  - cryptsetup
  - cifs-utils
  # Time sync
  - chrony
  # Allow communication between sudo and SSSD
  # for caching sudo rules by SSSD.
  # https://github.com/coreos/fedora-coreos-tracker/issues/445
  - libsss_sudo
  # Extra runtime
  - sssd shadow-utils
  # There are things that write outside of the journal still (such as the classic wtmp, etc.)
  # (auditd also writes outside the journal but it has its own log rotation.)
  # Anything package layered will also tend to expect files dropped in
  # /etc/logrotate.d to work.  Really, this is a legacy thing, but if we don't
  # have it then people's disks will slowly fill up with logs.
  - logrotate
  # Used by admins interactively
  - sudo coreutils attr less tar xz gzip bzip2
  - socat net-tools bind-utils
  - bash-completion
  - openssl
  - vim-minimal
  - lsof
  # Provides terminal tools like clear, reset, tput, and tset
  - ncurses
  # file-transfer: note fuse-sshfs is not in RHEL
  # so we can't put it in file-transfer.yaml
  - fuse-sshfs
  # User experience
  - console-login-helper-messages-issuegen
  - console-login-helper-messages-motdgen
  - console-login-helper-messages-profile
  - toolbox
  # CoreOS Installer
  - coreos-installer coreos-installer-bootinfra
  # i18n
  - kbd
  # Parsing/Interacting with JSON data
  - jq
  # nvme-cli for managing nvme disks
  - nvme-cli

# This thing is crying out to be pulled into systemd, but that hasn't happened
# yet.  Also we may want to add to rpm-ostree something like arch negation;
# basically right now it doesn't exist on s390x.
# Anyways, it was requested by the Red Hat perf team for RHCOS, so we have it here.
# https://serverfault.com/questions/513807/is-there-still-a-use-for-irqbalance-on-modern-hardware
# https://access.redhat.com/solutions/41535
packages-x86_64:
  - irqbalance
packages-ppc64le:
  - irqbalance
packages-aarch64:
  - irqbalance

# See https://github.com/coreos/bootupd
arch-include:
  x86_64: bootupd.yaml
  aarch64: bootupd.yaml
