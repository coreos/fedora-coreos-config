ref: fedora/${basearch}/coreos/rawhide
include: manifests/fedora-coreos.yaml

releasever: "36"

rojig:
  license: MIT
  name: fedora-coreos
  summary: Fedora CoreOS rawhide

repos:
  - fedora-rawhide

add-commit-metadata:
  fedora-coreos.stream: rawhide

packages:
  # for nsswitch.conf
  - authselect

postprocess:
  # Disable Zincati and fedora-coreos-pinger on non-production streams
  # https://github.com/coreos/fedora-coreos-tracker/issues/163
  - |
    #!/usr/bin/env bash
    set -xeuo pipefail
    mkdir -p /etc/fedora-coreos-pinger/config.d /etc/zincati/config.d
    echo -e '# https://github.com/coreos/fedora-coreos-tracker/issues/163\nreporting.enabled = false' > /etc/fedora-coreos-pinger/config.d/90-disable-on-non-production-stream.toml
    echo -e '# https://github.com/coreos/fedora-coreos-tracker/issues/163\nupdates.enabled = false' > /etc/zincati/config.d/90-disable-on-non-production-stream.toml

  # The ownership of nsswitch.conf has moved to authselect in F36+
  # and right now the file is created by running authselect in a
  # %posttrans, which fails. We need to work around this problem.
  # This workaround is twofold:
  #
  #   - Manually input nsswitch.conf during the build process so
  #     that rpm-ostree won't fail when it tries to inject altfiles.
  #   - Run `authselect` on first boot to create all the files it needs
  #     and re-add altfiles entries to newly created nsswitch.conf.
  #
  # https://github.com/coreos/fedora-coreos-tracker/issues/1051
  - |
    #!/usr/bin/bash
    set -xeuo pipefail
    cat <<'EOF' > /etc/nsswitch.conf
    # In order of likelihood of use to accelerate lookup.
    passwd:     files sss systemd
    shadow:     files
    group:      files sss systemd
    hosts:      files resolve [!UNAVAIL=return] myhostname dns
    services:   files sss
    netgroup:   files sss
    automount:  files sss
    
    aliases:    files
    ethers:     files
    gshadow:    files
    networks:   files dns
    protocols:  files
    publickey:  files
    rpc:        files
    EOF
    cat <<'EOF' > /usr/lib/systemd/system/rpm-ostree-authselect.service
      [Unit]
      # https://github.com/coreos/fedora-coreos-tracker/issues/1051
      Description=Run Authselect on RPM-OSTree System to Workaround Issue
      ConditionPathExists=!/etc/authselect/nsswitch.conf
      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/bin/authselect select sssd with-silent-lastlog --force
      ExecStartPost=sed -i -E "s/^(passwd|group):(.*?)files/\1:\2files altfiles/" /etc/nsswitch.conf
      [Install]
      WantedBy=default.target
    EOF
    ln -s /usr/lib/systemd/system/rpm-ostree-authselect.service /etc/systemd/system/multi-user.target.wants/rpm-ostree-authselect.service
