#!/usr/bin/bash
set -euo pipefail

# This script will migrate a FCOS system running the default configuration
# to systemd-resolved, which is standard for Fedora 33. For non OSTree Fedora
# systems the RPM post scriptlet takes care of the transition.
# https://fedoraproject.org/wiki/Changes/systemd-resolved
# https://github.com/coreos/fedora-coreos-tracker/issues/646

# If we're not on f33 yet then hard exit.
source /usr/lib/os-release
if [ "$VERSION_ID" == "32" ]; then
    echo 'Delaying systemd-resolved migration until Fedora 33'
    exit 0
fi

# Here we have a bit of logic:
#
#   - Does /etc/resolv.conf exist?
#      - It should since tmpfiles will create it otherwise
#      - If it doesn't, do nothing.
#   - Is /etc/resolv.conf currently being managed by NetworkManager?
#      - This is the default configuration in <F33.
#      - If yes, then create symlink to stub-resolv.conf
#   
if [ -f /etc/resolv.conf ]; then
    if [ "$(head -n 1 /etc/resolv.conf)" == '# Generated by NetworkManager' ]; then
       echo 'Detected that NetworkManager is managing resolv.conf'
       echo 'Migrating to systemd-resolved for Fedora 33 change'
       ln -fsv ../run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
    fi
fi

# Only run this on Fedora 33 once
systemctl disable coreos-migrate-to-systemd-resolved.service
