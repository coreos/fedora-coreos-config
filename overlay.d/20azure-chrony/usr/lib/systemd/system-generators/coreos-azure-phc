#!/bin/bash
set -euo pipefail
# See https://docs.microsoft.com/en-us/azure/virtual-machines/linux/time-sync
# and https://github.com/openshift/installer/pull/3513

# Generators don't have logging right now
# https://github.com/systemd/systemd/issues/15638
exec 1>/dev/kmsg; exec 2>&1

self=$(basename $0)

# Yeah this isn't a completely accurate kernel argument parser but
# we don't have one shared across shell services at the moment.
if ! grep -qF ' ignition.platform.id=azure' /proc/cmdline; then
    echo "$self: Not running on Azure"
    exit 0
fi

if ! cmp {/usr,}/etc/chrony.conf >/dev/null; then
    echo "$self: /etc/chrony.conf is modified; not changing the default"
    exit 0
fi
confpath=/run/coreos-azure-phc-chrony.conf
(echo '# Generated by coreos-azure-phc, see also https://docs.microsoft.com/en-us/azure/virtual-machines/linux/time-sync'
 echo '# and https://github.com/openshift/installer/pull/3513'
 sed -e s,'^pool,#pool,' < /etc/chrony.conf
 echo 'refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0'
) > "${confpath}"
# Policy doesn't allow chronyd to read run_t
chcon --reference=/etc/chrony.conf "${confpath}"

UNIT_DIR="${1:-/tmp}"

unitconfpath="${UNIT_DIR}/chronyd.service.d/coreos-azure-phc.conf"
mkdir -p $(dirname "${unitconfpath}")
cat >"${unitconfpath}" << EOF
[Service]
ExecStart=
ExecStart=/usr/sbin/chronyd -f ${confpath} \$OPTIONS
EOF

echo "$self: Updated chrony to use Azure PHC"
